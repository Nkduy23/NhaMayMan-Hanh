<!DOCTYPE html>
<html lang="vi">
  <head>
    <script>
      (function () {
        const hostname = window.location.hostname;
        const isDev =
          hostname === "127.0.0.1" || hostname === "localhost" || hostname === "0.0.0.0";
        window.BASE_PATH = isDev ? "/" : "/NhaMayMan-Hanh/";

        // Set <base> sync đầu head để fix tất cả relative path sau
        if (!document.querySelector("base")) {
          const baseTag = document.createElement("base");
          baseTag.href = window.BASE_PATH;
          document.head.insertBefore(baseTag, document.head.firstChild);
        }
      })();
    </script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Hoàn tất ủng hộ - HẠNH</title>
  </head>
  <body>
    <!-- Header -->
    <header></header>

    <!-- Main -->
    <main>
      <div class="checkout-container">
        <div class="checkout-box">
          <h1>Hoàn tất ủng hộ</h1>
          <p class="subtitle">Mỗi sản phẩm là một hành động yêu thương</p>

          <!-- Form thông tin -->
          <form id="checkout-form" class="checkout-form">
            <div class="form-group">
              <label>Họ và tên *</label>
              <input type="text" required placeholder="Nguyễn Văn A" />
            </div>

            <div class="form-group">
              <label>Số điện thoại *</label>
              <input type="tel" required pattern="[0-9]{10}" placeholder="0901234567" />
            </div>

            <div class="form-group">
              <label>Địa chỉ nhận hàng *</label>
              <textarea
                required
                rows="3"
                placeholder="Số nhà, đường, phường/xã, quận/huyện, tỉnh/thành"
              ></textarea>
            </div>
          </form>

          <!-- Tổng kết giỏ hàng -->
          <div id="checkout-summary" class="summary-box">
            <p>Đang tải giỏ hàng...</p>
          </div>

          <!-- Nút xác nhận -->
          <button id="confirm-btn" class="confirm-button">XÁC NHẬN ỦNG HỘ</button>

          <!-- Modal cảm ơn -->
          <div id="thankyou-modal" class="modal hidden">
            <div class="modal-overlay"></div>
            <div class="modal-content">
              <svg class="success-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                ></path>
              </svg>
              <h2>Cảm ơn bạn!</h2>
              <p>Đơn ủng hộ đã được ghi nhận. Chúng tôi sẽ liên hệ sớm.</p>
              <a href="index.html" class="modal-button">Về trang chủ</a>
            </div>
          </div>
        </div>
      </div>
    </main>

    <footer></footer>

    <script src="assets/js/config.js"></script>
    <script src="assets/js/inject-css.js"></script>
    <script src="assets/js/layout.js"></script>
    <script type="module">
      import { products } from "./assets/data/products-home/products.js";

      const cart = JSON.parse(localStorage.getItem("cart")) || [];
      const summaryEl = document.getElementById("checkout-summary");
      const form = document.getElementById("checkout-form");
      const confirmBtn = document.getElementById("confirm-btn");
      const modal = document.getElementById("thankyou-modal");

      // Render giỏ hàng (FIX: Sử dụng item.category để tìm sản phẩm, và field đúng: product_name, price_range)
      function renderSummary() {
        if (cart.length === 0) {
          summaryEl.innerHTML = `<p class="empty-message">Giỏ hàng trống!</p>`;
          confirmBtn.disabled = true;
          confirmBtn.classList.add("disabled");
          return;
        }

        let html = `<h3 class="summary-title">Chi tiết ủng hộ:</h3><ul class="summary-list">`;
        let total = 0;
        cart.forEach((item) => {
          // FIX: Tìm theo category và id, giống cart.html
          const p = products[item.category]?.find((x) => x.id === item.id);
          if (p) {
            // FIX: Dùng price_range và product_name
            const amount = p.price_range * item.qty;
            total += amount;
            html += `<li class="summary-item"><span>${p.product_name} × ${
              item.qty
            }</span><span class="summary-amount">${amount.toLocaleString("vi-VN")} ₫</span></li>`;
          }
        });
        html += `</ul><div class="total-section">
      <span class="total-label">TỔNG CỘT</span>
      <span class="total-amount">${total.toLocaleString("vi-VN")} ₫</span>
    </div>`;
        summaryEl.innerHTML = html;
      }

      // Xử lý xác nhận (FIX: Tương tự, dùng category và price_range)
      confirmBtn.addEventListener("click", () => {
        if (!form.checkValidity()) {
          alert("Vui lòng điền đầy đủ thông tin!");
          return;
        }

        // Lấy thông tin
        const name = form.querySelector('input[type="text"]').value;
        const phone = form.querySelector('input[type="tel"]').value;
        const address = form.querySelector("textarea").value;

        // Hiển thị modal
        modal.classList.remove("hidden");

        // XÓA GIỎ HÀNG SAU KHI XÁC NHẬN
        localStorage.removeItem("cart");

        // (Tùy chọn) Gửi dữ liệu về server ở đây (dùng fetch)
        // FIX: Tính total đúng
        const total = cart.reduce(
          (s, i) =>
            s + (products[i.category]?.find((p) => p.id === i.id)?.price_range || 0) * i.qty,
          0
        );
        console.log("Đơn ủng hộ:", {
          name,
          phone,
          address,
          cart,
          total,
        });
      });

      // Khởi động
      renderSummary();
    </script>

    <script>
      const pageCss = ["assets/css/checkout.css"];
      pageCss.forEach((href) => {
        if (!document.querySelector(`link[href="${href}"]`)) {
          const link = document.createElement("link");
          link.rel = "stylesheet";
          link.href = href;
          document.head.appendChild(link);
        }
      });
    </script>
  </body>
</html>
