<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Giỏ hàng - HẠNH</title>
    <!-- Inline set <base> sync (copy cho mọi page nếu cần) -->
    <script>
      (function () {
        const hostname = window.location.hostname;
        const isDev =
          hostname === "127.0.0.1" || hostname === "localhost" || hostname === "0.0.0.0";
        window.BASE_PATH = isDev ? "/" : "/NhaMayMan-Hanh/";

        // Set <base> sync đầu head để fix tất cả relative path sau
        if (!document.querySelector("base")) {
          const baseTag = document.createElement("base");
          baseTag.href = window.BASE_PATH;
          document.head.insertBefore(baseTag, document.head.firstChild);
        }
      })();
    </script>
  </head>
  <body>
    <header></header>
    <main>
      <div class="cart-container">
        <div class="cart-content">
          <!-- Danh sách sản phẩm -->
          <div class="cart-list">
            <div class="cart-header">
              <h1>Giỏ hàng</h1>
              <span id="item-count">0 sản phẩm</span>
            </div>
            <div id="cart-items" class="cart-items"></div>

            <a href="index.html" class="continue-shopping">
              <svg class="arrow-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M15 19l-7-7 7-7"
                ></path>
              </svg>
              Tiếp tục mua sắm
            </a>
          </div>

          <!-- Tổng kết -->
          <div class="cart-summary">
            <div class="summary-box">
              <h2>Tổng kết</h2>
              <div class="summary-items">
                <div class="summary-row">
                  <span>Tổng tiền hàng</span>
                  <span id="subtotal">0 ₫</span>
                </div>
                <div class="summary-row">
                  <span>Phí vận chuyển</span>
                  <span id="shipping-fee">0 ₫</span>
                </div>
              </div>

              <div class="total-section">
                <div class="total-row">
                  <span>TỔNG CỘNG</span>
                  <span id="total-cost">0 ₫</span>
                </div>
              </div>

              <button id="checkout-btn" class="checkout-button" disabled>HOÀN TẤT ỦNG HỘ</button>
            </div>
          </div>
        </div>
      </div>
    </main>

    <footer></footer>

    <!-- Load script chung: relative ngắn với <base> (không ../) -->
    <script src="assets/js/config.js"></script>
    <script src="assets/js/inject-css.js"></script>
    <script src="assets/js/layout.js"></script>

    <script type="module">
      // Import với relative ngắn ( <base> fix path)
      import { products } from "./assets/data/products-home/products.js";

      let cart = JSON.parse(localStorage.getItem("cart")) || [];
      const cartItemsEl = document.getElementById("cart-items");
      const itemCountEl = document.getElementById("item-count");
      const subtotalEl = document.getElementById("subtotal");
      const shippingFeeEl = document.getElementById("shipping-fee");
      const totalCostEl = document.getElementById("total-cost");
      const checkoutBtn = document.getElementById("checkout-btn");

      const formatPrice = (price) => price.toLocaleString("vi-VN") + " ₫";

      function renderCart() {
        cartItemsEl.innerHTML = "";
        if (cart.length === 0) {
          cartItemsEl.innerHTML = `<p class="empty-cart">Giỏ hàng trống</p>`;
          updateSummary();
          checkoutBtn.disabled = true;
          return;
        }
        checkoutBtn.disabled = false;

        cart.forEach((item, i) => {
          const p = products[item.category]?.find((x) => x.id === item.id);
          if (!p) return;

          const div = document.createElement("div");
          div.className = "cart-item";
          div.innerHTML = `
            <img src="assets/img/products-home/${p.img}" alt="${p.product_name}" />
            <div class="item-info">
              <h3 class="item-name">${p.product_name}</h3>
              ${item.size ? `<p class="item-size">Kích thước: ${item.size}</p>` : ""}
            </div>
            <div class="qty-controls">
              <button onclick="updateQty(${i},-1)" class="qty-btn">-</button>
              <input type="text" value="${item.qty}" readonly class="qty-input" />
              <button onclick="updateQty(${i},1)" class="qty-btn">+</button>
            </div>
            <p class="item-price">${formatPrice(p.price_range * item.qty)}</p>
            <button onclick="removeItem(${i})" class="remove-btn">
              <svg class="remove-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
          `;
          cartItemsEl.appendChild(div);
        });
        updateSummary();
      }

      window.updateQty = (i, d) => {
        if (d < 0 && cart[i].qty <= 1) return; // Không cho qty < 1
        cart[i].qty = Math.max(1, cart[i].qty + d);
        save();
        renderCart();
      };
      window.removeItem = (i) => {
        if (confirm("Xóa sản phẩm này?")) {
          // Thêm confirm
          cart.splice(i, 1);
          save();
          renderCart();
        }
      };
      const save = () => localStorage.setItem("cart", JSON.stringify(cart));

      function updateSummary() {
        const subtotal = cart.reduce(
          (s, item) =>
            s +
            (products[item.category]?.find((p) => p.id === item.id)?.price_range || 0) * item.qty,
          0
        );
        const shipping = 0; // Có thể dynamic từ select nếu thêm
        subtotalEl.textContent = formatPrice(subtotal);
        shippingFeeEl.textContent = formatPrice(shipping);
        totalCostEl.textContent = formatPrice(subtotal + shipping);
        itemCountEl.textContent = `${cart.reduce((sum, item) => sum + item.qty, 0)} sản phẩm`; // Đếm qty thay vì length
      }

      // Event cho checkout (mẫu, thêm logic thật)
      checkoutBtn.addEventListener("click", () => {
        if (cart.length > 0) {
          // alert("Chuyển đến checkout! (Demo)");
          window.location.href = "./pages/checkout.html";
        }
      });

      renderCart();
    </script>

    <script>
      const pageCss = ["assets/css/cart.css"];
      pageCss.forEach((href) => {
        if (!document.querySelector(`link[href="${href}"]`)) {
          const link = document.createElement("link");
          link.rel = "stylesheet";
          link.href = href;
          document.head.appendChild(link);
        }
      });
    </script>
  </body>
</html>
